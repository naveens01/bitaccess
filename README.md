# Spoke Nginx

## Overview

This helm chart will deploy **native Nginx in Spoke environments**. This will expose the loadbalancer via which the communication happens between Hub and Spoke, Customer and Spoke (**Inbound Private Link**). Reason for using native Nginx is because of Ingress controllers limitation (Combination of Host and Port based routing). This also exposes one loadbalancer as a public LB for inbound traffic to access API products (API Gateway, DevPortal, API Controlplane).

## Kubernetes Resources

Below are the list of Kubernetes resources as part of this helm chart that would get created:

| S.No | Kind                 | Namespace    | Resource                                                                                                            | Conditional Resources                                                                                                                                    | Comments                                             |
| ---- | -------------------- | ------------ | ------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| 1    | PodDisruptionBudget  | spoke-system | <ol><li>spoke-nginx-pdb</li></ol>                                                                                   | Gets created only when number of replicas of nginx is greater than 1                                                                                      | Pod disruption budget to make availability for nginx during evictions |
| 2    | ServiceAccount       | spoke-system | <ol><li>apigwnginxuser</li></ol>                                                                                    | Gets created only when `products.apigw` helm value is set to **enabled**                                                                                  | Service account for apigw nginx config jobs          |
| 3    | ConfigMap            | spoke-system | <ol><li>apigw-nginx-config</li><li>apigw-nginx-error-config</li><li>apigw-nginx-http-settings</li><li>ctrlplane-nginx-config</li><li>devportal-nginx-config</li><li>boc-nginx-server-config</li><li>integration-nginx-server-config</li><li>integration-multi-domain-config</li><li>integration-um-nginx-mapping-config</li><li>kubecost-nginx-config</li><li>spoke-nginx-exporter-config</li><li>spoke-nginx-common-config</li><li>nginx-app-config</li><li>spoke-nginx-config-properties</li></ol> | <ol><li>apigw-nginx-config - Gets created only when `products.apigw` helm value is set to **enabled**</li><li>apigw-nginx-error-config - Gets created only when `products.apigw` helm value is set to **enabled**</li><li>apigw-nginx-http-settings - Gets created only when `products.apigw` helm value is set to **enabled**</li><li>ctrlplane-nginx-config - Gets created only when `products.ctrlplane` helm value is set to **enabled**</li><li>devportal-nginx-config - Gets created only when `products.devportal` helm value is set to **enabled**</li><li>boc-nginx-server-config - Gets created only when `products.boc` helm value is set to **enabled**</li><li>integration-nginx-server-config - Gets created only when `products.integration` helm value is set to **enabled**</li><li>integration-multi-domain-config - Gets created only when `products.integration` helm value is set to **enabled** and `applications.spoke-nginx.products.integration.multiDomainEnabled` helm value is set to **true**</li><li>integration-um-nginx-mapping-config - Gets created only when `products.integration` helm value is set to **enabled**</li><li>kubecost-nginx-config - Gets created only when `kubecost.status` helm value is set to **enabled**</li><li>spoke-nginx-exporter-config - Gets created only when `nginxLogExporter` helm value is set to **enabled**</li><li>spoke-nginx-common-config - No</li><li>nginx-app-config - No</li><li>spoke-nginx-config-properties - Gets created only when `products.integration` helm value is set to **enabled**</li></ol> | These configmaps have product-specific nginx configurations |
| 4    | Role                 | spoke-system | <ol><li>nginx-config-reloader</li></ol>                                                                             | Gets created only when `products.apigw` helm value is set to **enabled**                                                                                  | Role permission to get pods, jobs, and exec inside pod for apigw nginx config jobs to do reloads |
| 5    | RoleBinding          | spoke-system | <ol><li>nginx-config-reloader</li></ol>                                                                             | Gets created only when `products.apigw` helm value is set to **enabled**                                                                                  | For binding the role                                 |
| 6    | Service              | spoke-system | <ol><li>spoke-nginx-svc-internal-lb</li><li>spoke-nginx-svc-customer-lb</li><li>spoke-nginx-svc-lb</li></ol>         | <ol><li>spoke-nginx-svc-internal-lb - No</li><li>spoke-nginx-svc-customer-lb - Gets created when `customerLbStatus` helm value is set to **enabled**</li><li>spoke-nginx-svc-lb - Gets created when `products.apigw` or `products.devportal` helm value is set to **enabled**</li></ol> | <ol><li>spoke-nginx-svc-internal-lb service is used for communication from hub to spoke via Private Link.</li><li>spoke-nginx-svc-customer-lb service is for communication from customer's VPC to spoke via Private Link (**Inbound Private Link**).</li><li>spoke-nginx-svc-lb service is for communication to API products UI (API Gateway, DevPortal) via **Internet**</li></ol> |
| 7    | StatefulSet          | spoke-system | <ol><li>spoke-nginx</li></ol>                                                                                       | No                                                                                                                                                        | Nginx gets deployed using this                       |
| 8    | Job                  | spoke-system | <ol><li>prepare-nginx-deps</li></ol>                                                                                | Gets created only when `products.apigw` helm value is set to **enabled**                                                                                  | This job will prepare initial nginx configs and dependencies creation like creation of config directories in file share |
| 9    | CronJob              | spoke-system | <ol><li>nginx-ssl-config-backup</li></ol>                                                                           | Gets created only when `products.apigw` helm value is set to **enabled**                                                                                  | Cronjob to take SSL certificates backup of API GW    |
| 10   | ExternalSecret       | spoke-system | <ol><li>product-secrets</li></ol>                                                                                   | Gets created only when `products.apigw` or `products.devportal` helm value is set to **enabled**                                                          | It would create a K8S secret which would have Keycloak client details for TMS and TM |
| 11   | ScaledObject         | spoke-system | <ol><li>spoke-nginx-scaledobject</li></ol>                                                                          | Gets created only when `hpaEnabled` helm value is set to **enabled**                                                                                      | It is a CRD of **Keda**, which is used for **horizontal pod autoscaling** of spoke-nginx |
| 12   | ServiceMonitor       | spoke-system | <ol><li>spoke-nginx-svc-monitor</li></ol>                                                                           | No                                                                                                                                                        | It is a CRD of **Prometheus**, which is used for scraping metrics |

## Working

Spoke Nginx is the single entry point of traffic in Spoke environment for all products. API product's nginx configurations are maintained in **file share** since in normal environments as well it is maintained like the same and during tenant provisioning/decommissioning tenant specific nginx config gets created/deleted dynamically using K8S jobs. By default, one private loadbalancer (**spoke-nginx-svc-internal-lb**) will get created for communication between hub and spoke. When API product (Gateway or DevPortal) is deployed in spoke, another loadbalancer (**spoke-nginx-svc-lb**) will get created which will be exposed over the internet. For customer's traffic over Private Link to Spoke, another private loadbalancer (**spoke-nginx-svc-customer-lb**) will be created.

![Request Flow Diagram](./images/spoke-nginx.png)

## Secrets Used

| S.No | Secret                                  | Consumer                                                 |
| ---- | --------------------------------------- | -------------------------------------------------------- |
| 1    | product-secrets                         | <ol><li>Spoke Nginx Statefulset</li></ol>                |
| 2    | {integration-external-domain-config-certs} | <ol><li>Spoke Nginx Statefulset</li><li>prepare-nginx-deps Job</li></ol> |
| 3    | apigw-tms-auth-secret-spoke             | <ol><li>Spoke Nginx Statefulset</li></ol>                |
| 4    | apigw-tms-auth-secret                   | <ol><li>Spoke Nginx Statefulset</li></ol>                |
| 5    | dpo-cloudflare-origin-certs             | <ol><li>Spoke Nginx Statefulset</li></ol>                |
| 6    | dpo-cloudflare
